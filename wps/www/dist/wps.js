!function(){var e=null;let t=null;var a=null,i=null,s={},r={},n=null;function l(){$("#processing-title").html(""),$("#processing-abstract").html(""),$("#processing-info-inputs tr:not(:first)").remove(),$("#processing-info-outputs tr:not(:first)").remove(),document.getElementById("processing-input").innerHTML="",document.getElementById("processing-form-errors").innerHTML="";var e=this.options[this.selectedIndex].value;""!=e&&OpenLayers.Request.GET({url:lizWpsUrls.wps_wps,params:{SERVICE:"WPS",REQUEST:"DescribeProcess",VERSION:a.version,IDENTIFIER:e,repository:lizUrls.params.repository,project:lizUrls.params.project},success:function(t){i=(new OpenLayers.Format.WPSDescribeProcess).read(t.responseText).processDescriptions[e],s[e]=OpenLayers.Util.extend({},i),function(){$("#processing-title").html(i.title),"abstract"in i&&""!=i.abstract&&$("#processing-abstract").html(i.abstract),document.getElementById("processing-input").innerHTML="<h3>Input:</h3>",document.getElementById("processing-form-errors").innerHTML="",$("#processing-info-inputs tr:not(:first)").remove(),$("#processing-info-outputs tr:not(:first)").remove(),document.getElementById("processing-form-container").setAttribute("data-value",i.identifier);var e,t=i.dataInputs,a=!0,s=i.processOutputs;t||(t=[]),s||(s=[]);for(var r=0,n=t.length;r<n;++r){if((e=t[r]).complexData){var l=e.complexData.supported.formats;l["application/vnd.geo+json"]?c(e):l["application/wkt"]||l["text/xml; subtype=gml/3.1.1"]||l["text/xml; subtype=gml/2.1.2"]||l["text/xml; subtype=wfs-collection/1.0"]||l["image/tiff"]||l["text/xml; subtype=sld/1.0.0"]||(a=!1)}else e.boundingBoxData?p(e):e.literalData?d(e):a=!1;if(e.minOccurs>0){var o=document.getElementById("processing-input-"+e.identifier.replaceAll(":","_")+"-label");o.classList.add("jforms-required");var u=document.createElement("span");u.classList.add("jforms-required-star"),u.appendChild(document.createTextNode("* ")),o.appendChild(u)}var g="<tr>";if(g+="<td>"+e.title+"</td>",e.boundingBoxData)g+="<td>Bounding box</td>";else if(e.literalData){var m=e.literalData.dataType;if("processMetadata"in e){var v=e.processMetadata.type;g+="number"==v?"<td>"+v+" ("+m+")</td>":"<td>"+v+"</td>"}else g+="<td>"+m+"</td>"}else g+="<td></td>";e.minOccurs>0?g+="<td>&#10003;</td>":g+="<td></td>",g+="</tr>",$("#processing-info-inputs tr:last").after(g)}for($("#processing-input button.wps-digitizing").each((function(){var e=$(this);e.hasClass("extent")?function(e){var t=document.getElementById(e);t.onclick=function(){$(t).hasClass("active")?(lizMap.mainLizmap.digitizing.toolSelected="deactivate",$(t).removeClass("active")):($("#processing-input button.wps-digitizing.active").removeClass("active"),lizMap.mainLizmap.digitizing.toolSelected="box",$(t).addClass("active"))}}(e.attr("id")):e.hasClass("point")&&function(e){var t=document.getElementById(e);t.onclick=function(){$(t).hasClass("active")?(lizMap.mainLizmap.digitizing.toolSelected="deactivate",$(t).removeClass("active")):($("#processing-input button.wps-digitizing.active").removeClass("active"),lizMap.mainLizmap.digitizing.toolSelected="point",$(t).addClass("active"))}}(e.attr("id"))})),lizMap.mainEventDispatcher.addListener((()=>{var e=$("#processing-input button.wps-digitizing.active");e.hasClass("extent")?function(e){var t=document.getElementById(e),a=t.previousSibling,i=lizMap.mainLizmap.digitizing.featureDrawn.at(-1);i.set("text",a.title);var s=lizMap.ol.extent.applyTransform(i.getGeometry().getExtent(),lizMap.ol.proj.getTransform(lizMap.ol.proj.get(lizMap.mainLizmap.projection),lizMap.ol.proj.get(a.value)));t.parentElement.firstChild.value=s.join(",")+" ("+a.value+")",t.parentElement.firstChild.onblur(),lizMap.mainLizmap.digitizing.featureDrawn.length>1&&lizMap.mainLizmap.digitizing._eraseFeature(lizMap.mainLizmap.digitizing.featureDrawn.at(0))}(e.attr("id")):e.hasClass("point")&&function(e){var t=document.getElementById(e),a=t.previousSibling,i=lizMap.mainLizmap.digitizing.featureDrawn.at(-1);i.set("text",a.title),t.parentElement.firstChild.value='{ "geometry": '+(new lizMap.ol.format.GeoJSON).writeGeometry(i.getGeometry(),{featureProjection:lizMap.mainLizmap.projection,dataProjection:a.value})+',  "crs": { "type": "name", "properties": { "name": "'+a.value+'" } } }',t.parentElement.firstChild.onblur(),lizMap.mainLizmap.digitizing.featureDrawn.length>1&&lizMap.mainLizmap.digitizing._eraseFeature(lizMap.mainLizmap.digitizing.featureDrawn.at(0))}(e.attr("id"))}),["digitizing.featureDrawn"]),r=0,n=s.length;r<n;++r)g="<tr>",g+="<td>"+s[r].title+"</td>",g+="<td></td>",g+="</tr>",$("#processing-info-outputs tr:last").after(g);if(a){var h=document.createElement("div");h.setAttribute("class","form-actions");var b=document.createElement("button");b.innerHTML="Execute",b.setAttribute("class","btn"),h.appendChild(b),document.getElementById("processing-input").appendChild(h),b.onclick=f,lizMap.events.triggerEvent("processingFormBuild",{identifier:i.identifier})}else document.getElementById("processing-input").innerHTML='<span class="notsupported">Sorry, the WPS builder does not support the selected process.</span>'}(),o(e)}})}function o(e){return!(!e||""==e||($.get(lizWpsUrls.wps_wps_results,{repository:lizUrls.params.repository,project:lizUrls.params.project,identifier:e},(function(e){if(e){for(var t in e)e[t]&&(r[t]=e[t],b(e[t]));M()}})),0))}function c(e,t){var a=e.identifier,i=document.getElementById("processing-input"),s=document.createElement("div");s.setAttribute("class","control-group"),s.id="processing-input-"+a.replaceAll(":","_")+"-group";var r=document.createElement("label");r.setAttribute("class","jforms-label control-label"),r.setAttribute("for","processing-input-"+a.replaceAll(":","_")),r.innerHTML=e.title,r.id="processing-input-"+a.replaceAll(":","_")+"-label",s.appendChild(r);var n=document.createElement("div");n.setAttribute("class","controls"),s.appendChild(n);var l=document.createElement("input");l.title=e.title,l.id="processing-input-"+a.replaceAll(":","_"),l.name=a,l.title=e.title,n.appendChild(l);var o="";"processMetadata"in e&&(o=e.processMetadata.type);var c="qgisType-"+o;l.setAttribute("class",c),i.appendChild(s),g(l,(function(){e.data=l.value?{complexData:{mimeType:"application/vnd.geo+json",encoding:"utf8",schema:"",value:l.value}}:defaultValue}));var p=document.createElement("select");p.id="processing-input-"+a.replaceAll(":","_")+"-select",p.setAttribute("class","span1 wps-digitizing extent");var d=document.createElement("option");d.value=lizMap.config.options.qgisProjectProjection.ref,d.label=lizMap.config.options.qgisProjectProjection.ref.split(":")[1],p.appendChild(d);var u=document.createElement("option");u.value=lizMap.config.options.projection.ref,u.label=lizMap.config.options.projection.ref.split(":")[1],p.appendChild(u);var f=document.createElement("button");f.id="processing-input-"+a.replaceAll(":","_")+"-btn",f.setAttribute("class","btn btn-mini wps-digitizing wkt "+o),f.innerHTML="Drawing "+o,$(l).after(f).after(p).after("<br>")}function p(e){var t=e.identifier,a=document.getElementById("processing-input"),i=document.createElement("div");i.setAttribute("class","control-group"),i.id="processing-input-"+t.replaceAll(":","_")+"-group";var s=document.createElement("label");s.setAttribute("class","jforms-label control-label"),s.setAttribute("for","processing-input-"+t.replaceAll(":","_")),s.innerHTML=e.title,s.id="processing-input-"+t.replaceAll(":","_")+"-label",i.appendChild(s);var r=document.createElement("div");r.setAttribute("class","controls"),i.appendChild(r);var n=document.createElement("input");n.title=e.title,n.value="left,bottom,right,top (EPSG:4326)",n.id="processing-input-"+t.replaceAll(":","_"),n.name=t,n.title=e.title,r.appendChild(n);var l="";"processMetadata"in e&&(l=e.processMetadata.type);var o="qgisType-"+l;n.setAttribute("class",o),a.appendChild(i),g(n,(function(){var t=/(-?\d+\.?\d*) *, *(-?\d+\.?\d*) *, *(-?\d+\.?\d*) *, *(-?\d+\.?\d*) *\((EPSG:\d+)\)/gi.exec(n.value);if(void 0!==t&&6==t.length){var a=t[5].toUpperCase(),i=[t[1],t[2],t[3],t[4]];"EPSG:4326"==a&&(i=[t[2],t[1],t[4],t[3]]),i=OpenLayers.Bounds.fromArray(i),e.boundingBoxData={projection:a,bounds:i},e.data={boundingBoxData:{projection:a,bounds:i}}}}));var c=document.createElement("select");c.id="processing-input-"+t.replaceAll(":","_")+"-select",c.setAttribute("class","span1 wps-digitizing extent");var p=document.createElement("option");p.value=lizMap.config.options.qgisProjectProjection.ref,p.label=lizMap.config.options.qgisProjectProjection.ref.split(":")[1],c.appendChild(p);var d=document.createElement("option");d.value=lizMap.config.options.projection.ref,d.label=lizMap.config.options.projection.ref.split(":")[1],c.appendChild(d);var u=document.createElement("button");u.id="processing-input-"+t.replaceAll(":","_")+"-btn",u.setAttribute("class","btn btn-mini wps-digitizing extent"),u.innerHTML="Drawing extent",$(n).after(u).after(c).after("<br>")}function d(e,t){var a=e.identifier,s=document.getElementById("processing-input"),r=document.createElement("div");r.setAttribute("class","control-group"),r.id="processing-input-"+a.replaceAll(":","_")+"-group";var n=document.createElement("label");n.setAttribute("class","jforms-label control-label"),n.setAttribute("for","processing-input-"+a.replaceAll(":","_")),n.innerHTML=e.title,n.id="processing-input-"+a.replaceAll(":","_")+"-label",r.appendChild(n);var l=document.createElement("div");l.setAttribute("class","controls"),r.appendChild(l);var o=e.literalData.dataType,c=e.literalData.anyValue;"boolean"==o&&(c=!1,e.literalData.allowedValues={False:!0,True:!0});var p="";"processMetadata"in e&&(p=e.processMetadata.type);var f="";"defaultValue"in e.literalData&&(f=e.literalData.defaultValue);var m=[];"undefined"!=typeof wps_wps_project_config&&i.identifier in wps_wps_project_config&&a in wps_wps_project_config[i.identifier]&&(m=wps_wps_project_config[i.identifier][a],$.isArray(m)||(m=[]));var v=[],h=[];if("vector"==p||"raster"==p||"source"==p)for(x in lizMap.config.layers)"layer"==(E=lizMap.config.layers[x]).type&&(0!=m.length&&-1==m.indexOf(x)||("geometryType"in E?v.push(x):h.push(x)));var b=document.createElement("boolean"==o||"string"==o&&!c||"field"==p||"vector"==p||"raster"==p||"source"==p?"select":"input");b.id="processing-input-"+a.replaceAll(":","_"),b.name=a,b.title=e.title,l.appendChild(b);var y="qgisType-"+p;if(b.setAttribute("class",y),t&&t.nextSibling?s.insertBefore(b,t.nextSibling):s.appendChild(r),"vector"==p||"source"==p){(T=document.createElement("option")).innerHTML="---",b.appendChild(T);for(var L=0,M=v.length;L<M;L++){var x=v[L],E=lizMap.config.layers[x];(T=document.createElement("option")).value=x,T.innerHTML=E.title,b.appendChild(T)}b.onchange=function(){u(e,b,d),function(e,t){var a=$("#processing-input select.fieldParentLayerParameterName-"+e.identifier.replaceAll(":","_"));if(0!=a.length){var i=$(t).val();if(i&&""!=i){a.each((function(e,t){$(t).children().remove(),$(t).append("<option>---</option>")}));var s=document.getElementById("processing-form-container").dataset.value,r=[];if("undefined"!=typeof wps_wps_project_config&&s in wps_wps_project_config){var n=a[0].name;n in wps_wps_project_config[s]&&(r=wps_wps_project_config[s][n],$.isArray(r)||(r=[]))}var l=OpenLayers.Util.urlAppend(lizUrls.wms,OpenLayers.Util.getParameterString(lizUrls.params));$.get(l,{SERVICE:"WFS",VERSION:"1.0.0",REQUEST:"DescribeFeatureType",TYPENAME:i,OUTPUTFORMAT:"JSON"},(function(e){var t=e.aliases,i={};for(var s in"types"in e&&(i=e.types),t)a.each((function(e,a){var n="";if(s in i&&(n=i[s]),!($(a).hasClass("fieldDataType-DateTime")&&"date"!=n&&"time"!=n&&"dateTime"!=n&&""!=n||$(a).hasClass("fieldDataType-Numeric")&&"integer"!=n&&"long"!=n&&"double"!=n&&""!=n||$(a).hasClass("fieldDataType-String")&&"string"!=n&&"Date"!=n&&""!=n||0!=r.length&&-1==r.indexOf(s))){var l=t[s];""!=l?$(a).append('<option value="'+s+'">'+l+"</option>"):$(a).append('<option value="'+s+'">'+s+"</option>")}}));a.each((function(e,t){2==t.children.length&&(t.selectedIndex=1),t.onchange()}))}),"json")}}}(e,b),function(e,t){var a=$(t).parent().find('input[type="checkbox"].selection');if(0!=a.length){var i=$(t).val();if(i&&""!=i){var s=lizMap.config.layers[i];a.attr("disabled","disabled"),a.parent().addClass("disabled"),null!=a.attr("checked")&&a.removeAttr("checked"),("selectedFeatures"in s&&s.selectedFeatures.length>0||"filteredFeatures"in s&&s.filteredFeatures.length>0||"request_params"in s&&"exp_filter"in s.request_params&&s.request_params.exp_filter)&&(a.removeAttr("disabled"),a.parent().removeClass("disabled"))}}}(0,b);var t=this.options[this.selectedIndex].value;e.data=t&&""!=t?{literalData:{value:t}}:void 0},"source"==p&&($(b).after('<br><label class="checkbox inline disabled"><input id="processing-input-'+a.replaceAll(":","_").replaceAll(" ","_")+'-selection" type="checkbox" class="selection" disabled="disabled">Sélection</label>'),$(b).parent().find('input[type="checkbox"].selection').change((function(){var t=$(this);if(t.is(":checked")){t.attr("checked","checked");var a=e.data.literalData.value,i=a;i.startsWith("layer:")&&(i=i.split("?")[0].slice(6));var s=lizMap.config.layers[i];"selectedFeatures"in s&&s.selectedFeatures.length>0?a="layer:"+i+"?select="+encodeURIComponent("$id IN ( "+s.selectedFeatures.join()+" )"):"filteredFeatures"in s&&s.filteredFeatures.length>0?a="layer:"+i+"?select="+encodeURIComponent("$id IN ( "+s.filteredFeatures.join()+" )"):"request_params"in s&&"exp_filter"in s.request_params&&s.request_params.exp_filter&&(a="layer:"+i+"?select="+encodeURIComponent(s.request_params.exp_filter)),e.data.literalData.value=a}else{null!=t.attr("checked")&&t.removeAttr("checked");var r=t.parent().parent().find("select").val();e.data.literalData.value=r}}))),2==b.children.length&&(b.selectedIndex=1,b.onchange())}else if("field"==p){(T=document.createElement("option")).innerHTML="---",b.appendChild(T),y+=" ",y+="fieldParentLayerParameterName-"+e.processMetadata.parentLayerParameterName.replaceAll(":","_"),y+=" ",y+="fieldDataType-"+e.processMetadata.dataType,b.setAttribute("class",y),b.onchange=function(){u(e,b,d),e.data=this.selectedIndex?{literalData:{value:this.options[this.selectedIndex].value}}:void 0};var w=document.getElementById("processing-input-"+e.processMetadata.parentLayerParameterName.replaceAll(":","_"));""!=w.value&&w.onchange()}else if("raster"==p){for((T=document.createElement("option")).innerHTML="---",b.appendChild(T),L=0,M=h.length;L<M;L++)x=h[L],E=lizMap.config.layers[x],(T=document.createElement("option")).value=x,T.innerHTML=E.title,b.appendChild(T);b.onchange=function(){u(e,b,d),e.data=this.selectedIndex?{literalData:{value:this.options[this.selectedIndex].value}}:void 0},2==b.children.length&&(b.selectedIndex=1,b.onchange())}else if("boolean"==o||"string"==o&&!c){var T;for(var S in(T=document.createElement("option")).innerHTML="---",b.appendChild(T),e.literalData.allowedValues)(T=document.createElement("option")).value=S,T.innerHTML=S,b.appendChild(T);b.onchange=function(){u(e,b,d),e.data=this.selectedIndex?{literalData:{value:this.options[this.selectedIndex].value}}:void 0},f&&($(b).val(f),b.onchange())}else f?(b.value=f,f={literalData:{value:f}},e.data=f):(b.value=a+(o?" ("+o+")":""),f=void 0),g(b,(function(){e.data=b.value?{literalData:{value:b.value}}:f,u(e,b,d)}))}function u(e,t,a){if(e.maxOccurs&&e.maxOccurs>1&&!t.userSelected){t.userSelected=!0;var s=OpenLayers.Util.extend({},e);s.occurrence=(e.occurrence||0)+1,i.dataInputs.push(s),a(s,t)}}function g(e,t){e.onclick=function(){this.initialValue||(this.initialValue=this.value,this.value="")},e.onblur=function(){this.value||(this.value=this.initialValue,delete this.initialValue),t.apply(this,arguments)}}function f(){document.getElementById("processing-form-errors").innerHTML="";var e,t=OpenLayers.Util.extend({},i),a=t.dataInputs;a||(a=t.dataInputs=[]);for(var s=a.length-1;s>=0;--s)if(0!==(e=a[s]).minOccurs&&!e.occurrence||e.data||e.reference){if("processMetadata"in e){var n="";if("processMetadata"in e&&(n=e.processMetadata.type),"source"==n){var l=e.data.literalData.value,o=l;o.startsWith("layer:")&&(o=o.split("?")[0].slice(6));var c=lizMap.config.layers[o];"filteredFeatures"in c&&c.filteredFeatures.length>0?l="layer:"+o+"?select="+encodeURIComponent("$id IN ( "+c.filteredFeatures.join()+" )"):"request_params"in c&&"exp_filter"in c.request_params&&c.request_params.exp_filter&&(l="layer:"+o+"?select="+encodeURIComponent(c.request_params.exp_filter));var p=e.identifier;$("#processing-input-"+p.replaceAll(":","_").replaceAll(" ","_")+"-selection").is(":checked")&&"selectedFeatures"in c&&c.selectedFeatures.length>0&&(l="layer:"+o+"?select="+encodeURIComponent("$id IN ( "+c.selectedFeatures.join()+" )")),e.data.literalData.value=l}}}else OpenLayers.Util.removeItem(a,e);var d=[];for(s=t.processOutputs.length-1;s>=0;--s){var u=t.processOutputs[s],g={identifier:u.identifier};u.complexOutput&&(g.asReference=!0),d.push(g)}t.responseForm={responseDocument:{storeExecuteResponse:!0,status:!0,outputs:d}};var f=(new OpenLayers.Format.WPSExecute).write(t),m=(new Date).toISOString();return OpenLayers.Request.POST({url:lizWpsUrls.wps_wps,params:lizUrls.params,data:f,success:function(e){!function(e,t,a){var i,s=t.getResponseHeader("Content-Type");if("application/wkt"==s?i=(new OpenLayers.Format.WKT).read(t.responseText):"text/xml; subtype=wfs-collection/1.0"==s&&(i=(new OpenLayers.Format.WFST.v1_0_0).read(t.responseText)),i&&(i instanceof OpenLayers.Feature.Vector||i.length))layer.addFeatures(i);else if(s&&s.startsWith("text/xml")){var n=(new OpenLayers.Format.WPSExecute).read(t.responseText);$('#processing-log-list li[data-value="'+e.identifier+'"]:not(.expanded)').addClass("expanded"),n.executeResponse&&function(e,t){$("li.processing-results:not(.active) #button-processing-results").click();var a=E(e,t),i=a.uuid;r[i]=a,b(a),y(i),L(i),M()}(n.executeResponse,a),n.exceptionReport&&function(e){var t=document.getElementById("processing-form-errors"),a='<div class="alert alert-error">';a+="<ul>";for(var i=0,s=e.exceptions.length;i<s;i++)for(var r=e.exceptions[i],n=0,l=r.texts.length;n<l;n++)a+="<li>"+r.texts[n]+"</li>";a+="</ul>",a+="</div>",t.innerHTML=a}(n.exceptionReport)}}(t,e,m)},failure:function(){}}),!1}function m(e,t){var a=e.indexOf("?");if(-1!==a)for(var i=e.substring(a+1).split("&"),s=0;s<i.length;s++){var r=i[s].split("=");if(decodeURIComponent(r.shift()).toLowerCase()==t.toLowerCase())return decodeURIComponent(r.join("="))}}function v(e,t){$.getJSON(t,{},(function(t){return"errors"in t?(console.error("Dataviz configuration error"),console.error(t.errors),!1):!t.data||t.data.length<1?null:void lizDataviz.buildPlot(e,t)}))}function h(){const e=document.querySelectorAll("#processing-results-list div.processing-results-plot");if(e.length)for(const t of e){const e=t.querySelectorAll("div.processing-results-plot-display .js-plotly-plot");if(e.length){const a=parseInt(t.querySelector("div.processing-results-plot-display").clientWidth);for(const t of e)Plotly.relayout(t.id,{width:a})}}}function b(a){if(!a)return;if(!a.uuid)return;const i=a.uuid,s=a.startTime,n=a.status,l=(a.endTime,i.substring(0,13));let o='<tr id="log-'+i+'" data-value="'+s+'">';o+="<td>","Succeeded"==n?o+='<input type="checkbox" class="" id="check-'+i+'" value="results-'+i+'" title="Toggle process results"></input>':"Failed"==n&&(o+='<input type="checkbox" class="" id="check-'+i+'" value="results-'+i+'" title="Toggle process information"></input>'),o+="</td>";let c=[],p="",d="";if("undefined"!=typeof wps_wps_project_config&&a.identifier in wps_wps_project_config&&"__job_label"in wps_wps_project_config[a.identifier]&&(d=wps_wps_project_config[a.identifier].__job_label),a.dataInputs)for(var u=0,g=a.dataInputs.length;u<g;++u){var f=a.dataInputs[u];f.data&&f.data.literalData&&c.push(f.data.literalData.value),""!=d&&f.identifier==d&&(p=f.data.literalData.value),""==d&&f.processMetadata&&f.processMetadata.type&&("sink"==f.processMetadata.type||"vectorDestination"==f.processMetadata.type||"rasterDestination"==f.processMetadata.type||"fileDestination"==f.processMetadata.type)&&(p=f.data.literalData.value)}""==p?p=new Date(s).toLocaleString():c.unshift(new Date(s).toLocaleString()),o+='<td title="'+l+'">',"Succeeded"!=n&&"Failed"!=n||(o+='<label class="" id="label-'+i+'" for="check-'+i+'" title="'+c.join(", ")+'"></input>'),o+=p,o+="</label></td>",o+="Accepted"==n||"Started"==n?'<td><span class="badge badge-info"><i class="icon-white icon-refresh"></i></span></td>':"Paused"==n?'<td><span class="badge badge-warning"><i class="icon-white icon-pause"></i></span></td>':"Succeeded"==n?'<td><span class="badge badge-success"><i class="icon-white icon-ok"></i></span></td>':"Failed"==n?'<td><span class="badge badge-important"><i class="icon-white icon-remove"></i></span></td>':"<td>"+n+"</td>",o+="</tr>";var b=$("#log-"+i),y=!1;if(0==b.length){logTrList=$('#processing-log-list li[data-value="'+a.identifier+'"] .processing-log-list-results tr');var L=logTrList.length;logTrList.each((function(e,t){if(t=$(t),s>t.attr("data-value"))return t.before(o),!1})),$('#processing-log-list li[data-value="'+a.identifier+'"] .processing-log-list-results tr').length==L&&$('#processing-log-list li[data-value="'+a.identifier+'"] .processing-log-list-results').append(o)}else b.find("input").unbind("click"),y=b.find("input").checked,b.replaceWith(o);b=$("#log-"+i),y&&(b.find("input").checked=!0),b.find("input").click((function(){var a=$(this).val(),i="",s="";a.startsWith("results-")?(i=a.replaceAll("results-",""),s="results"):a.startsWith("failed-")&&(i=a.replaceAll("failed-",""),s="failed"),i in r?(r[i],"results"==s?function(a){var i=r[a],s=$("#log-"+a).find('button[value="results-'+a+'"].checkbox');$("#processing-results-list").show();var n=$('#processing-results-list div[data-value="'+i.identifier+'"]');if(n.show(),s.addClass("checked"),0==n.find('table.processing-results-literal-table tr:first th[class="'+a+'"]').length){var l=!1;if(i.dataInputs){if(1==n.find("table.processing-results-detail-table tr").length)for(var o=0,c=i.dataInputs.length;o<c;++o){var p='<tr data-value="'+(g=i.dataInputs[o]).identifier+'">';if(p+="<td>"+g.title+"</td>",g.boundingBoxData)p+="<td>Bounding box</td>";else if(g.literalData){var d=g.literalData.dataType;if("processMetadata"in g){var u=g.processMetadata.type;p+="number"==u?"<td>"+u+" ("+d+")</td>":"<td>"+u+"</td>"}else p+="<td>"+d+"</td>"}else p+="<td></td>";p+="</tr>",n.find("table.processing-results-detail-table tr:last").after(p)}for(n.find("table.processing-results-detail-table tr:first th:last").after('<th class="'+a+'">'+new Date(i.startTime).toLocaleString()+"</th>"),o=0,c=i.dataInputs.length;o<c;++o){var g,f='<td class="'+a+'">';if((g=i.dataInputs[o]).boundingBoxData&&g.data&&g.data.boundingBoxData)f+=(b=g.data.boundingBoxData.bounds).left+", "+b.bottom+", "+b.right+", "+b.top+" ("+g.data.boundingBoxData.projection+")";else if(g.boundingBoxData&&g.data&&g.data.literalData){var b;f+=(b=g.data.literalData.value).left+", "+b.bottom+", "+b.right+", "+b.top}else g.data&&g.data.complexData?f+=g.data.complexData.value:g.data&&g.data.literalData?f+=g.data.literalData.value:f+="Not set";f+="</td>",n.find('table.processing-results-detail-table tr[data-value="'+g.identifier+'"] td:last').after(f),l=!0}}n.find("div.processing-results-detail").toggle(l);var y=!1;if(1==n.find("table.processing-results-literal-table tr").length)for(o=0,c=i.processOutputs.length;o<c;++o)(z=i.processOutputs[o]).literalData&&(p='<tr data-value="'+z.identifier+'">',p+="<td>"+z.title+"</td>",p+="</tr>",n.find("table.processing-results-literal-table tr:last").after(p));for(n.find("table.processing-results-literal-table tr:first th:last").after('<th class="'+a+'">'+new Date(i.startTime).toLocaleString()+"</th>"),o=0,c=i.processOutputs.length;o<c;++o)(z=i.processOutputs[o]).literalData&&(f='<td class="'+a+'">'+z.literalData.value+"</td>",n.find('table.processing-results-literal-table tr[data-value="'+z.identifier+'"] td:last').after(f),y=!0);n.find("div.processing-results-literal").toggle(y);var L=!1;if(1==n.find("table.processing-results-layer-table tr").length)for(o=0,c=i.processOutputs.length;o<c;++o)(z=i.processOutputs[o]).reference&&z.reference.mimeType&&"application/x-ogc-wms"==z.reference.mimeType&&null!=(M=m(C=z.reference.href,"layer")||m(C,"layers"))&&(p='<tr data-value="'+z.identifier+'">',p+="<td>"+z.title+"</td>",p+="</tr>",n.find("table.processing-results-layer-table tr:last").after(p));for(n.find("table.processing-results-layer-table tr:first th:last").after('<th class="'+a+'">'+new Date(i.startTime).toLocaleString()+"</th>"),o=0,c=i.processOutputs.length;o<c;++o){if(!(z=i.processOutputs[o]).reference)continue;if(!z.reference.mimeType)continue;if("application/x-ogc-wms"!=z.reference.mimeType)continue;var M,x=m(C=z.reference.href,"map");if(null==(M=m(C,"layer")||m(C,"layers")))continue;var E=a+"-"+z.identifier.replaceAll(":","_").replaceAll(" ","_"),w=OpenLayers.Util.urlAppend(C.substring(0,C.indexOf("?")+1),OpenLayers.Util.getParameterString({map:x})),T={version:"1.3.0",layers:M,styles:"",crs:"EPSG:900913"!=e.getProjection()?e.getProjection():"EPSG:3857",format:"image/png",transparent:"true",exceptions:"application/vnd.ogc.se_inimage",dpi:96};const s=new lizMap.ol.layer.Image({source:new lizMap.ol.source.ImageWMS({url:w,params:T,ratio:1,serverType:"qgis"}),properties:{wpsLayerName:E,wmsTitle:i.title+" "+M}});null===t&&(t=lizMap.mainLizmap.state.rootMapGroup.createExternalGroup("WPS Results")),t.addOlLayer(E,s).icon="data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9IjE2IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJtMTEuMTU4IDEuNS0uODAzIDIuMjM0LjAxMi4xMy4zOSAxLjk0LTIuMjYuOTM0LTEuMDk1LTEuNjQ2LS4wODQtLjA5OC0yLjE0OC0xLjAxNC0xLjE5IDEuMTkgMS4wMTQgMi4xNDguMDk4LjA4NCAxLjY0NiAxLjA5Ni0uOTM1IDIuMjU4LTEuOTQtLjM5LS4xMy0uMDEtMi4yMzMuODAydjEuNjg0bDIuMjM0LjgwMy4xMy0uMDEyIDEuOTQtLjM5LjkzNCAyLjI2LTEuNjQ2IDEuMDk1LS4wOTguMDg0LTEuMDE0IDIuMTQ4IDEuMTkgMS4xOSAyLjE0OC0xLjAxNC4wODQtLjA5OCAxLjA5Ni0xLjY0NiAyLjI1OC45MzUtLjM5IDEuOTQtLjAxLjEzLjgwMiAyLjIzM2gxLjY4NGwuODAzLTIuMjM0LS4wMTItLjEzLS4zOS0xLjk0IDIuMjYtLjkzNCAxLjA5NSAxLjY0Ni4wODQuMDk4IDIuMTQ4IDEuMDE0IDEuMTktMS4xOS0xLjAxNC0yLjE0OC0uMDk4LS4wODQtMS42NDYtMS4wOTYuOTM1LTIuMjU4IDEuOTQuMzkuMTMuMDEgMi4yMzMtLjgwMnYtMS42ODRsLTIuMjM0LS44MDMtLjEzLjAxMi0xLjk0LjM5LS45MzQtMi4yNiAxLjY0Ni0xLjA5NS4wOTgtLjA4NCAxLjAxNC0yLjE0OC0xLjE5LTEuMTktMi4xNDggMS4wMTQtLjA4NC4wOTgtMS4wOTYgMS42NDYtMi4yNTgtLjkzNS4zOS0xLjk0LjAxLS4xMy0uODAyLTIuMjMzem0uODQyIDhhMi41IDIuNSAwIDAgMSAyLjUgMi41IDIuNSAyLjUgMCAwIDEgLTIuNSAyLjUgMi41IDIuNSAwIDAgMSAtMi41LTIuNSAyLjUgMi41IDAgMCAxIDIuNS0yLjV6IiBmaWxsPSIjOThiNWQ4IiBzdHJva2U9IiM0NTdhYmUiLz48L3N2Zz4K",f='<td class="'+a+'">',f+="<span>"+M+"</span>",f+='<button style="display:none;" class="btn btn-mini layerDownload" value="'+E+'" title="'+M+'">',f+='<i class="icon-download-alt"></i>',f+="</button>",f+="</td>",n.find('table.processing-results-layer-table tr[data-value="'+z.identifier+'"] td:last').after(f),L=!0;var S={SERVICE:"WMS",VERSION:"1.3.0",REQUEST:"GetLegendGraphic",LAYER:M,STYLE:"",SLD_VERSION:"1.1.0",EXCEPTIONS:"application/vnd.ogc.se_inimage",FORMAT:"image/png",TRANSPARENT:"TRUE",WIDTH:150,LAYERFONTSIZE:9,ITEMFONTSIZE:9,SYMBOLSPACE:1,ICONLABELSPACE:2,LAYERFONTSIZE:0,LAYERSPACE:0,LAYERFONTBOLD:"FALSE",LAYERTITLE:"FALSE",DPI:96},I=OpenLayers.Util.getParameterString(S);I=OpenLayers.Util.urlAppend(w,I)}$('#processing-results-layer-table tr td[class="'+a+'"] button.layerView').click((function(){var e=$(this);return e.hasClass("checked")?(e.removeClass("checked"),lizMap.map.getLayersByName(e.val())[0].setVisibility(!1)):(e.addClass("checked"),lizMap.map.getLayersByName(e.val())[0].setVisibility(!0)),!1})),n.find('table.processing-results-layer-table tr td[class="'+a+'"] button.layerDownload').click((function(){var e=$(this);return e.val(),e.parent().attr("class"),e.parent().parent().attr("class"),!1})),n.find("div.processing-results-layer").toggle(L);var A=!1;if(1==n.find("table.processing-results-file-table tr").length)for(o=0,c=i.processOutputs.length;o<c;++o)(z=i.processOutputs[o]).reference&&z.reference.mimeType&&"application/x-ogc-wms"!=z.reference.mimeType&&(p='<tr data-value="'+z.identifier+'">',p+="<td>"+z.title+"</td>",p+="</tr>",n.find("table.processing-results-file-table tr:last").after(p));for(n.find("table.processing-results-file-table tr:first th:last").after('<th class="'+a+'">'+new Date(i.startTime).toLocaleString()+"</th>"),o=0,c=i.processOutputs.length;o<c;++o)if((z=i.processOutputs[o]).reference&&z.reference.mimeType&&"application/x-ogc-wms"!=z.reference.mimeType){var D=m(C=z.reference.href,"file");null==D&&(D=C.split("/").pop()),f='<td class="'+a+'">',f+="<span>"+D+"</span>",f+="&nbsp;",f+='<a class="btn btn-mini" target="_blank" href="'+C+'" title="'+z.title+'">',f+='<i class="icon-download-alt"></i>',f+="</button>",f+="</td>",n.find('table.processing-results-file-table tr[data-value="'+z.identifier+'"] td:last').after(f),A=!0}n.find("div.processing-results-file").toggle(A);var j=!1,O='<div class="processing-results-plot-display" data-value="'+a+'">';for(O+="<h5>"+new Date(i.startTime).toLocaleString()+"</h5>",O+="</div>",n.find("div.processing-results-plot-table").append(O),o=0,c=i.processOutputs.length;o<c;++o){var z;if((z=i.processOutputs[o]).reference&&z.reference.mimeType&&"application/json"==z.reference.mimeType){var C=z.reference.href,_="<p><strong>"+z.title+"</strong></p>";_+='<div id="'+a+"-"+z.identifier.replaceAll(":","_").replaceAll(" ","_")+'" style="height:400px;">',_+="</div>",n.find('div.processing-results-plot div[data-value="'+a+'"]').append(_),v(a+"-"+z.identifier.replaceAll(":","_").replaceAll(" ","_"),C),j=!0}}n.find("div.processing-results-plot").toggle(j)}else{n.find('div.processing-results-plot-table > div[data-value="'+a+'"]').remove(),(j=0!=n.find("div.processing-results-plot-table > div").length)||n.find("div.processing-results-plot").hide();for(const e of t.getChildren())e.olLayer.get("wpsLayerName").startsWith(a)&&t.removeOlLayer(e.name);n.find('table.processing-results-layer-table tr td[class="'+a+'"]').remove(),n.find('table.processing-results-layer-table tr th[class="'+a+'"]').remove(),(L=1!=n.find("table.processing-results-layer-table tr th").length)||n.find("div.processing-results-layer").hide(),n.find('table.processing-results-file-table tr td[class="'+a+'"]').remove(),n.find('table.processing-results-file-table tr th[class="'+a+'"]').remove(),(y=1!=n.find("table.processing-results-file-table tr th").length)||n.find("div.processing-results-file").hide(),n.find('table.processing-results-literal-table tr td[class="'+a+'"]').remove(),n.find('table.processing-results-literal-table tr th[class="'+a+'"]').remove(),(y=1!=n.find("table.processing-results-literal-table tr th").length)||n.find("div.processing-results-literal").hide(),n.find('table.processing-results-detail-table tr td[class="'+a+'"]').remove(),n.find('table.processing-results-detail-table tr th[class="'+a+'"]').remove(),(l=2!=n.find("table.processing-results-detail-table tr th").length)||n.find("div.processing-results-detail").hide(),j||L||y||n.hide(),s.removeClass("checked")}$("#button-processing-results").parent().hasClass("active")||$("#button-processing-results").click(),h()}(i):"failed"==s&&function(e){var t=r[e],a=$("#log-"+e).find('button[value="failed-'+e+'"].checkbox'),i=$("#processing-log-failed-uuid"),s=i.text();if($("#processing-log-failed-messages").html(""),$("#processing-log-failed .processing-log-failed-detail-table tr.wps-input").remove(),$("#processing-log-failed-creation").html(""),$("#processing-log-failed-identifier").html(""),$("#processing-log-failed-title").html(""),e==s)return $("#processing-log-failed").hide(),i.html(""),void a.removeClass("checked");$("#log-"+s).find('button[value="failed-'+s+'"]').removeClass("checked"),a.addClass("checked"),$("#processing-log-failed-title").html(t.title),$("#processing-log-failed-identifier").html(t.identifier),i.html(e),$("#processing-log-failed-creation").html(new Date(t.startTime).toLocaleString());for(var n=0,l=t.dataInputs.length;n<l;++n){var o=t.dataInputs[n],c='<tr class="wps-input" data-value="'+o.identifier+'">';c+="<td>"+o.title+"</td>",c+="<td>",o.data&&o.data.literalData?c+=o.data.literalData.value:o.data&&o.data.complexData?c+=o.data.complexData.value:c+="Not set",c+="</td>",c+="</tr>",$("#processing-log-failed .processing-log-failed-detail-table").append(c)}$("#processing-log-failed-messages").html("");var p='<div class="alert alert-error">';for(p+="<ul>",n=0,l=t.exceptions.length;n<l;n++)p+="<li>"+t.exceptions[n]+"</li>";p+="</ul>",p+="</div>",$("#processing-log-failed-messages").html(p),$("#processing-log-failed").show()}(i)):console.warn("unknown uuid")}))}function y(e){if(e in r){var t=r[e],a=lizWpsUrls.wps_wps_results_update,i=t.identifier,s={repository:lizUrls.params.repository,project:lizUrls.params.project,identifier:i};$.ajax(a+="?"+$.param(s),{data:JSON.stringify(r[e]),contentType:"application/json",type:"POST",success:function(e){}})}}function L(e){if(e in r){var t=r[e];t.reloadStatus=!0,r[e]=t,OpenLayers.Request.GET({url:lizWpsUrls.wps_wps,params:{SERVICE:"WPS",REQUEST:"GetResults",uuid:e},success:function(t){var a=E((new OpenLayers.Format.WPSExecute).read(t.responseText).executeResponse);e=a.uuid,r[e]=a,b(a),y(e)},failure:function(){}})}}function M(){var e=5;n=window.setInterval((function(){x(e-=1)}),1e3)}function x(e){var t=0;for(var a in r){var i=r[a];i.reloadStatus||"Failed"!=i.status&&"Succeeded"!=i.status&&(L(a),t+=1)}n&&(0==t?(window.clearInterval(n),n=null):e<0&&(window.clearInterval(n),n=window.setInterval((function(){x(1)}),1e4)))}function E(e,t){var a=m(e.statusLocation,"uuid"),s=e.status.creationTime,n="Accepted";"processFailed"in e.status?n="Failed":"processStarted"in e.status?n="Started":"processPaused"in e.status?n="Paused":"processSucceeded"in e.status&&(n="Succeeded");var l=[];if("Failed"==n&&e.status.exceptionReport&&e.status.exceptionReport.exceptions)for(var o=e.status.exceptionReport.exceptions,c=0,p=o.length;c<p;c++)l=l.concat(o[c].texts);var d=null;return a in r?((d=r[a]).status=n,d.processOutputs=e.processOutputs?e.processOutputs:[],d.exceptions=l,d.endTime="Accepted"==n||"Started"==n?"":s,d.reloadStatus=!1):d=JSON.parse(JSON.stringify({uuid:a,identifier:i.identifier,title:i.title,dataInputs:i.dataInputs,startTime:"Accepted"==n||"Started"==n?s:t,status:n,processOutputs:e.processOutputs?e.processOutputs:[],exceptions:l,endTime:"Accepted"==n||"Started"==n?"":s,reloadStatus:!1})),d}lizMap.events.on({uicreated:function(t){const i=document.querySelector("#processing-processes"),s=document.querySelector("#processing-results");null!==i&&null!==s&&(lizMap.config,e=lizMap.map,"wps_wps"in lizWpsUrls&&$("#processing-processes").length&&($("#button-processing span.icon").css("background-image","none").html('<i class="icon-cog icon-white" style="margin-left: 4px;"></i>'),$("#button-processing-results span.icon").css("background-image","none").html('<i class="icon-eye-open icon-white" style="margin-left: 4px;"></i>'),document.getElementById("processing-processes").onchange=l,OpenLayers.Request.GET({url:lizWpsUrls.wps_wps,params:{SERVICE:"WPS",REQUEST:"GetCapabilities"},success:function(e){a=(new OpenLayers.Format.WPSCapabilities).read(e.responseText);var t,i=document.getElementById("processing-processes"),s=document.getElementById("processing-log-list"),r=document.getElementById("processing-results-list"),n=a.processOfferings;for(var l in n){if("undefined"!=typeof wps_wps_project_config&&!(l in wps_wps_project_config))continue;(t=document.createElement("option")).innerHTML=n[l].title,t.value=l,i.appendChild(t);const e=document.createElement("li");e.innerHTML='<span class="title">'+n[l].title+"</span>",e.dataset.value=l;const a=document.createElement("table");a.classList="processing-log-list-results table table-condensed table-striped",e.appendChild(a),s.appendChild(e);const o=document.createElement("div");o.innerHTML='<h4 class="title">'+n[l].title+"</h4>",o.dataset.value=l,o.style="display:none;",r.appendChild(o);const c=document.createElement("div");c.classList="processing-results-detail",c.style="display:none;",c.innerHTML='<h4>Inputs</h4><table class="processing-results-detail-table table table-condensed table-striped"><tbody><tr><th>Name</th><th>Type</th></tr></tbody></table>',o.appendChild(c);const p=document.createElement("div");p.classList="processing-results-literal",p.style="display:none;",p.innerHTML='<h4>Literals output</h4><table class="processing-results-literal-table table table-condensed table-striped"><tbody><tr><th>Name</th></tr></tbody></table>',o.appendChild(p);const d=document.createElement("div");d.classList="processing-results-layer",d.innerHTML='<h4>Layers output</h4><table class="processing-results-layer-table table table-condensed table-striped"><tbody><tr><th>Name</th></tr></tbody></table>',d.style="display:none;",o.appendChild(d);const u=document.createElement("div");u.classList="processing-results-file",u.innerHTML='<h4>Files output</h4><table class="processing-results-file-table table table-condensed table-striped"><tbody><tr><th>Name</th></tr></tbody></table>',u.style="display:none;",o.appendChild(u);const g=document.createElement("div");g.classList="processing-results-plot",g.innerHTML='<h4>Plots output</h4><div class="processing-results-plot-table"></div>',g.style="display:none;",o.appendChild(g),o.appendChild(document.createElement("hr"))}if(1==i.children.length)document.querySelectorAll("#mapmenu ul.nav-list li.processing")[0].style.display="none",document.querySelectorAll("#mapmenu ul.nav-list li.processing-results")[0].style.display="none";else for(const e of document.querySelectorAll("#processing-log-list > li .title"))e.addEventListener("click",(e=>{const t=e.target.parentElement;if(t.classList.toggle("expanded"),t.classList.contains("expanded")){const e=t.dataset.value;""!=e&&o(e)}}))}})),OpenLayers.Format.WPSDescribeProcess.prototype.namespaces.xlink="http://www.w3.org/1999/xlink",OpenLayers.Format.WPSDescribeProcess.prototype.readers.ows.Metadata=function(e,t){"processMetadata"in t||(t.processMetadata={});var a=this.getAttributeNS(e,this.namespaces.xlink,"type"),i=this.getAttributeNS(e,this.namespaces.xlink,"title"),s=this.getAttributeNS(e,this.namespaces.xlink,"href");"simple"==a&&i.startsWith("processing:")&&(t.processMetadata[i.slice(11)]=s)},OpenLayers.Format.WPSDescribeProcess.prototype.readers.wps.DefaultValue=function(e,t){t.defaultValue=this.getChildValue(e)},OpenLayers.Format.WPSExecute.prototype.namespaces.xlink="http://www.w3.org/1999/xlink",OpenLayers.Format.WPSExecute.prototype.readers.wps.Reference=function(e,t){t.reference={href:e.getAttribute("href"),mimeType:e.getAttribute("mimeType"),encoding:e.getAttribute("encoding"),schema:e.getAttribute("schema")},t.reference.href||(t.reference.href=this.getAttributeNS(e,this.namespaces.xlink,"href"))},OpenLayers.Format.WPSExecute.prototype.readers.wps.ProcessFailed=function(e,t){t.processFailed=!0,this.readChildNodes(e,t)},OpenLayers.Format.WPSExecute.prototype.readers.wps.ExceptionReport=function(e,t){t.exceptionReport={exceptions:[]},this.readChildNodes(e,t.exceptionReport)},OpenLayers.Format.WPSExecute.prototype.readers.wps.ProcessAccepted=function(e,t){t.processAccepted=!0},OpenLayers.Format.WPSExecute.prototype.readers.wps.ProcessStarted=function(e,t){t.processStarted=!0,t.percentCompleted=e.hasAttribute("percentCompleted")?e.getAttribute("percentCompleted"):null},OpenLayers.Format.WPSExecute.prototype.readers.wps.ProcessPaused=function(e,t){t.processPaused=!0},new ResizeObserver((()=>{h()})).observe(s),lizMap.events.on({dockopened:function(e){if(e.id="processing"){var t=$("#processing-processes option");2==t.length&&t.last().parent().val()!=t.last().val()&&(t.last().parent().val(t.last().val()),t.last().parent().change())}},layerSelectionChanged:function(e){$("#processing-form-container select.qgisType-source").each((function(t,a){if((a=$(a)).val()==e.featureType){var i=$(a).parent().find('input[type="checkbox"].selection'),s=!1;0!=i.length&&(s=i.is(":checked")),a.change(),s&&i.click()}}))}}))}})}();